<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KASIR Q - ULTIMATE FULL</title>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. CORE DESIGN SYSTEM (FULL & ELEGANT)
           ========================================= */
        :root {
            /* Warna Utama (Amber Gold) */
            --primary-color: #FFB300;
            --primary-dark: #F57F17;
            --primary-gradient: linear-gradient(135deg, #FFB300 0%, #FF8F00 100%);
            
            /* Backgrounds (Clean & Modern) */
            --bg-body: #F4F6F9;
            --bg-card: #FFFFFF;
            --bg-dark: #1E1E24;
            
            /* Text Colors */
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --text-light: #FFFFFF;
            
            /* Functional Colors */
            --success-color: #10B981;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            --pertalite-color: #22C55E;
            --expense-color: #F43F5E;
            --ai-color: #6366F1;
            --ai-gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            
            /* Effects */
            --glass-effect: blur(20px);
            --shadow-soft: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius-large: 24px;
            --border-radius-medium: 16px;
            
            /* Font */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            font-family: var(--font-family);
            color: var(--text-main);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* SVG Icons Helper */
        .icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; display: inline-block; vertical-align: middle; }
        .icon-small { width: 18px; height: 18px; stroke-width: 2.5; }

        /* =========================================
           2. ANIMATIONS & TRANSITIONS
           ========================================= */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* =========================================
           3. SCREEN COMPONENTS (Splash, PIN)
           ========================================= */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-card); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.6s ease;
        }
        .splash-logo { width: 130px; height: 130px; margin-bottom: 20px; animation: pulse 2.5s infinite; filter: drop-shadow(0 10px 20px rgba(255,179,0,0.3)); }

        #pin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111827; z-index: 9000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }
        .pin-dots { display: flex; gap: 20px; margin: 40px 0; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; background: rgba(255,255,255,0.2); transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .pin-dot.filled { background: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); transform: scale(1.2); border: none; }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .pin-btn { 
            width: 80px; height: 80px; border-radius: 50%; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: white; font-size: 26px; cursor: pointer; font-weight: 500;
            display: grid; place-items: center; transition: 0.2s; backdrop-filter: blur(5px);
        }
        .pin-btn:active { background: rgba(255,255,255,0.2); transform: scale(0.95); }

        /* Notification Toast */
        #notification {
            position: fixed; top: 20px; left: 20px; right: 20px;
            background: #1F2937; color: white;
            padding: 16px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex; align-items: center; gap: 12px;
            transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* =========================================
           4. MAIN LAYOUT & NAVIGATION
           ========================================= */
        .app-container {
            flex: 1;
            overflow-y: auto;
            /* Padding bawah besar agar tidak tertutup nav */
            padding-bottom: calc(120px + env(safe-area-inset-bottom));
            scrollbar-width: none;
        }

        .top-bar {
            position: sticky; top: 0; z-index: 100;
            padding: calc(15px + env(safe-area-inset-top)) 24px 15px 24px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(244, 246, 249, 0.9);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .app-title { font-size: 22px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .btn-icon-head { 
            width: 44px; height: 44px; border-radius: 14px; 
            background: white; border: 1px solid #E5E7EB; 
            display: grid; place-items: center; color: var(--text-main); 
            box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.1s;
        }
        .btn-icon-head:active { transform: scale(0.95); }
        .profile-head-img { 
            width: 44px; height: 44px; border-radius: 14px; 
            object-fit: cover; border: 2px solid white; 
            box-shadow: var(--shadow-sm); cursor: pointer;
        }

        /* View Sections (Halaman) */
        .view-section { display: none; padding: 0 24px; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }

        /* =========================================
           5. DASHBOARD COMPONENTS
           ========================================= */
        .hero-card {
            margin: 20px 0; padding: 24px;
            border-radius: var(--border-radius-large);
            background: linear-gradient(135deg, #111827 0%, #1F2937 100%);
            color: white;
            box-shadow: var(--shadow-float);
            position: relative; overflow: hidden;
        }
        /* Hiasan background */
        .hero-card::after {
            content:''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: var(--primary-color);
            filter: blur(90px); opacity: 0.15; border-radius: 50%;
        }
        .hero-label { font-size: 11px; font-weight: 700; opacity: 0.7; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; color: #D1D5DB; }
        .hero-balance { font-size: 36px; font-weight: 800; margin-bottom: 20px; color: #F3F4F6; }
        
        .split-stats-container { 
            display: flex; gap: 20px; padding-top: 20px; 
            border-top: 1px solid rgba(255,255,255,0.1); 
        }
        .split-item { flex: 1; }
        .split-label { font-size: 12px; opacity: 0.6; display: block; margin-bottom: 4px; }
        .split-value { font-size: 16px; font-weight: 700; color: var(--primary-color); }

        .report-card {
            background: white; border-radius: var(--border-radius-medium); padding: 20px;
            box-shadow: var(--shadow-soft); margin-bottom: 24px;
            display: flex; align-items: center; border: 1px solid #E5E7EB;
        }
        .chart-container { width: 110px; height: 110px; position: relative; }
        .stats-container { flex: 1; padding-left: 20px; display: flex; flex-direction: column; gap: 12px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; }
        .stat-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .stat-val { font-size: 15px; font-weight: 700; font-family: monospace; }
        .stat-val.income { color: var(--success-color); }
        .stat-val.expense { color: var(--danger-color); }

        .section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; margin-top: 20px; 
        }
        .section-title { font-size: 18px; font-weight: 800; color: var(--text-main); }

        /* List Styling */
        .list-container { display: flex; flex-direction: column; gap: 12px; }
        .list-item {
            background: white; padding: 16px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow-soft); border: 1px solid #F3F4F6;
            transition: transform 0.2s;
        }
        .list-item:active { transform: scale(0.98); }
        .li-left { display: flex; align-items: center; gap: 16px; }
        .li-icon { 
            width: 46px; height: 46px; border-radius: 14px; 
            background: #F3F4F6; display: grid; place-items: center; 
            font-size: 22px; color: #374151;
        }
        .li-icon.red { background: #FEF2F2; color: var(--danger-color); }
        .li-info h4 { margin: 0 0 4px; font-size: 15px; font-weight: 700; color: var(--text-main); }
        .li-info p { margin: 0; font-size: 12px; color: var(--text-muted); }
        .li-amount { font-weight: 800; font-size: 15px; color: var(--text-main); }
        .li-amount.negative { color: var(--danger-color); }

        /* =========================================
           6. POS (KASIR) & PRODUCTS
           ========================================= */
        .pos-cart-panel {
            background: white; border-radius: var(--border-radius-large);
            padding: 20px; margin-bottom: 24px;
            box-shadow: var(--shadow-float); border: 1px solid #E5E7EB;
        }
        .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px dashed #F3F4F6; }
        .cart-title { font-weight: 800; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .cart-reset { color: var(--danger-color); font-size: 12px; font-weight: 700; cursor: pointer; background: #FEF2F2; padding: 6px 12px; border-radius: 8px; }
        
        .cart-list-container { max-height: 200px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #F9FAFB; }
        .cart-controls { display: flex; align-items: center; gap: 10px; background: #F9FAFB; padding: 4px; border-radius: 8px; }
        .qty-btn { width: 28px; height: 28px; background: white; border: 1px solid #E5E7EB; border-radius: 6px; font-weight: 700; cursor: pointer; display:grid; place-items:center; }
        
        .cart-actions { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; }
        .btn-scan { background: #1F2937; color: white; border-radius: 14px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-pay { background: var(--primary-gradient); color: black; border-radius: 14px; border: none; font-weight: 800; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-size: 15px; box-shadow: 0 4px 15px rgba(255, 179, 0, 0.3); }

        .search-container { 
            background: white; padding: 12px 16px; border-radius: 16px; 
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px; 
            box-shadow: var(--shadow-sm); border: 1px solid #E5E7EB; 
        }
        .search-container input { border: none; width: 100%; outline: none; font-size: 15px; color: var(--text-main); }
        
        .grid-products { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding-bottom: 20px; }
        .product-card { 
            background: white; border-radius: 20px; padding: 16px; 
            box-shadow: var(--shadow-sm); position: relative; 
            border: 1px solid #F3F4F6; transition: transform 0.1s;
            display: flex; flex-direction: column;
        }
        .product-card:active { transform: scale(0.97); }
        .p-badge { position: absolute; top: 12px; right: 12px; font-size: 11px; font-weight: 700; background: #F3F4F6; padding: 4px 8px; border-radius: 6px; color: #6B7280; }
        .p-icon { font-size: 32px; margin-bottom: 12px; display: block; }
        .p-name { font-weight: 700; font-size: 14px; margin-bottom: 4px; line-height: 1.3; color: var(--text-main); }
        .p-price { font-weight: 800; color: #D97706; font-size: 14px; margin-top: auto; }

        /* =========================================
           7. POM MINI (GAS STATION)
           ========================================= */
        .tank-display { 
            background: white; padding: 24px; border-radius: 24px; 
            margin-bottom: 24px; box-shadow: var(--shadow-float); text-align: center; 
            border: 1px solid #F3F4F6; position: relative; overflow: hidden;
        }
        .tank-title { font-weight: 900; color: var(--pertalite-color); font-size: 20px; margin-bottom: 6px; display: block; letter-spacing: 1px; }
        .tank-price { font-size: 13px; color: #6B7280; margin-bottom: 20px; display: block; font-weight: 600; }
        
        .tank-progress-bg { height: 20px; background: #F3F4F6; border-radius: 10px; overflow: hidden; margin-bottom: 12px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .tank-progress-fill { 
            height: 100%; background: var(--pertalite-color); 
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 10px;
            background-image: linear-gradient(45deg,rgba(255,255,255,.2) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.2) 50%,rgba(255,255,255,.2) 75%,transparent 75%,transparent); 
            background-size: 1rem 1rem;
        }
        
        .pom-lcd-screen { 
            background: #111827; color: var(--primary-color); 
            font-family: 'Courier New', monospace; 
            padding: 24px; border-radius: 20px; text-align: right; 
            font-size: 38px; margin-bottom: 24px; 
            letter-spacing: 2px; font-weight: 700; 
            box-shadow: var(--shadow-float);
            text-shadow: 0 0 10px rgba(255, 179, 0, 0.4);
        }

        /* =========================================
           8. FORM, BUTTONS & UTILS
           ========================================= */
        .btn-large { 
            width: 100%; padding: 18px; border-radius: 18px; border: none; 
            background: var(--text-main); color: white; font-weight: 700; font-size: 16px; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: transform 0.2s;
        }
        .btn-large:active { transform: scale(0.98); }
        
        .btn-small { padding: 8px 16px; border-radius: 10px; background: var(--text-main); color: white; border: none; font-size: 12px; cursor: pointer; font-weight: 700; }
        
        .btn-ai-pill { 
            background: var(--ai-gradient); color: white; border: none; 
            padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; 
            display: flex; align-items: center; gap: 4px; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
        .form-input { 
            width: 100%; padding: 16px; border-radius: 14px; 
            border: 1px solid #E5E7EB; font-size: 16px; outline: none; 
            background: #F9FAFB; color: var(--text-main); transition: 0.3s;
        }
        .form-input:focus { border-color: var(--primary-color); background: white; }

        /* =========================================
           9. BOTTOM NAVIGATION (FLOATING)
           ========================================= */
        .bottom-nav {
            position: fixed; 
            bottom: calc(25px + env(safe-area-inset-bottom)); 
            left: 20px; right: 20px; 
            height: 75px; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            box-shadow: var(--shadow-float);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 1000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9CA3AF; cursor: pointer; transition: 0.3s; flex: 1; }
        .nav-item svg { width: 26px; height: 26px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item span { font-size: 10px; font-weight: 700; letter-spacing: 0.3px; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active svg { transform: translateY(-4px); }
        .nav-item.pom-active { color: var(--info-color); }

        .ai-float-btn {
            position: fixed; 
            bottom: calc(115px + env(safe-area-inset-bottom)); right: 24px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--ai-gradient);
            display: grid; place-items: center; color: white;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
            z-index: 1100; cursor: pointer; animation: float 3s ease-in-out infinite;
        }

        /* =========================================
           10. MODALS (SHEET)
           ========================================= */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2000; 
            display: none; justify-content: center; align-items: flex-end; 
            backdrop-filter: blur(4px); 
        }
        .modal.show { display: flex; animation: slideUp 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        
        .modal-sheet { 
            background: #F8FAFC; 
            width: 100%; max-height: 90vh; 
            border-top-left-radius: 32px; 
            border-top-right-radius: 32px; 
            padding: 30px 24px; 
            overflow-y: auto; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }

        .ai-chat-box { height: 350px; overflow-y: auto; background: white; border-radius: 16px; padding: 15px; border: 1px solid #E5E7EB; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px; }
        .ai-msg { padding: 12px 16px; border-radius: 14px; font-size: 14px; max-width: 85%; line-height: 1.5; }
        .ai-msg.bot { background: #F3F4F6; align-self: flex-start; border-bottom-left-radius: 2px; color: #1F2937; }
        .ai-msg.user { background: #E0E7FF; color: #3730A3; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .ai-suggestion-box { background: #EEF2FF; border: 1px solid #C7D2FE; border-radius: 12px; padding: 14px; font-size: 13px; color: #3730A3; margin-bottom: 20px; display: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="logo.png" alt="Logo" class="splash-logo" onerror="this.style.display='none'">
        <div style="font-weight:900; font-size:28px; margin-top:20px; letter-spacing:-1px; color:var(--text-main);">KASIR Q</div>
        <div style="color:var(--text-muted); font-weight:500; font-size:14px; margin-top:5px;">Ultimate Edition v19.0</div>
    </div>

    <div id="pin-screen">
        <div style="width:80px; height:80px; background:rgba(255,255,255,0.1); border-radius:50%; display:grid; place-items:center; margin-bottom:20px; backdrop-filter:blur(10px);">
            <svg class="icon" style="width:36px; height:36px; stroke:white;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
        </div>
        <h2 style="margin-bottom:5px; font-size:24px;">Akses Keamanan</h2>
        <p style="opacity:0.6; font-size:14px; margin-top:0;">Masukkan 6 Digit PIN Anda</p>
        
        <div class="pin-dots" id="pin-dots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        
        <div class="pin-pad">
            <button class="pin-btn" onclick="app.pin.enter(1)">1</button><button class="pin-btn" onclick="app.pin.enter(2)">2</button><button class="pin-btn" onclick="app.pin.enter(3)">3</button>
            <button class="pin-btn" onclick="app.pin.enter(4)">4</button><button class="pin-btn" onclick="app.pin.enter(5)">5</button><button class="pin-btn" onclick="app.pin.enter(6)">6</button>
            <button class="pin-btn" onclick="app.pin.enter(7)">7</button><button class="pin-btn" onclick="app.pin.enter(8)">8</button><button class="pin-btn" onclick="app.pin.enter(9)">9</button>
            <div></div><button class="pin-btn" onclick="app.pin.enter(0)">0</button>
            <button class="pin-btn" onclick="app.pin.del()" style="background:rgba(239,68,68,0.2); border-color:rgba(239,68,68,0.4)">âœ•</button>
        </div>
    </div>

    <div id="notification">
        <svg class="icon" style="color:var(--success-color)"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <div id="notif-msg" style="font-weight:600; font-size:14px;">Berhasil Disimpan</div>
    </div>

    <div class="top-bar">
        <div class="app-title" id="page-title">Dashboard</div>
        <div style="display:flex; gap:12px;">
            <button class="btn-icon-head" onclick="app.modal.open('settings')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1 2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
            </button>
            <img id="header-avatar" class="profile-head-img" src="" onclick="app.modal.open('profile')">
        </div>
    </div>

    <div class="app-container">

        <section id="view-dashboard" class="view-section active">
            <div class="hero-card">
                <div class="hero-label">OMZET BULAN INI</div>
                <div class="hero-balance"><span>Rp</span> <span id="dash-omzet">0</span></div>
                
                <div class="split-stats-container">
                    <div class="split-item">
                        <span class="split-label">Warung</span>
                        <strong class="split-value" id="dash-retail">Rp 0</strong>
                    </div>
                    <div style="width:1px; background:rgba(255,255,255,0.2);"></div>
                    <div class="split-item" style="padding-left:15px;">
                        <span class="split-label">Bensin</span>
                        <strong class="split-value" id="dash-pom">Rp 0</strong>
                    </div>
                </div>
            </div>

            <div class="section-header">
                <span class="section-title">Laporan Keuangan</span>
                <button class="btn-ai-pill" onclick="app.ai.analyzeDashboard()">
                    <svg class="icon icon-small" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg> 
                    Analisa AI
                </button>
            </div>
            
            <div id="ai-insight-text" class="ai-suggestion-box"></div>

            <div class="report-card">
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="stats-container">
                    <div class="stat-row">
                        <span class="stat-label">PEMASUKAN</span>
                        <span class="stat-val income" id="report-income">Rp 0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">PENGELUARAN</span>
                        <span class="stat-val expense" id="report-expense">Rp 0</span>
                    </div>
                </div>
            </div>

            <div class="section-header"><span class="section-title">Riwayat Terbaru</span></div>
            <div class="list-container" id="dashboard-history-list"></div>
            <div style="height:30px"></div>
        </section>

        <section id="view-pos" class="view-section">
            <div class="pos-cart-panel">
                <div class="cart-header">
                    <div class="cart-title">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg> 
                        Keranjang Belanja
                    </div>
                    <span class="cart-reset" onclick="app.pos.clearCart()">Hapus Semua</span>
                </div>
                
                <div class="cart-list-container" id="pos-cart-list">
                    <div style="text-align:center; padding:30px; color:#9CA3AF; font-style:italic;">Keranjang masih kosong...</div>
                </div>

                <div id="ai-checkout-suggest" class="ai-suggestion-box"></div>

                <div class="cart-actions">
                    <button class="btn-scan" onclick="app.scanner.start('pos')">
                        <svg class="icon icon-small" viewBox="0 0 24 24"><path d="M3 3h18v18H3z"></path></svg> Scan
                    </button>
                    <button class="btn-pay" onclick="app.pos.checkout()">
                        <span>Total:</span>
                        <span id="pos-total-display">0</span>
                    </button>
                </div>
            </div>

            <div class="search-container">
                <svg class="icon icon-small" style="color:#9CA3AF" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" placeholder="Cari nama produk / scan barcode..." oninput="app.pos.filterProducts(this.value)">
                <button class="btn-ai-pill" onclick="app.ai.getProductSuggestion(app.data.cart)">Saran AI</button>
            </div>

            <div class="grid-products" id="pos-product-grid"></div>
        </section>

        <section id="view-pom" class="view-section">
            <div class="tank-display">
                <span class="tank-title">PERTALITE</span>
                <span class="tank-price" id="pom-price-display">Rp 10.000 / Liter</span>
                <div class="tank-progress-bg"><div class="tank-progress-fill" id="tank-fill" style="width:50%"></div></div>
                <div style="font-size:12px; opacity:0.6;" id="tank-info">Stok: 50L / 100L</div>
            </div>
            
            <div style="display:flex; gap:12px; margin-bottom:24px;">
                <button class="btn-large" style="flex:1; background:white; color:var(--text-main); font-size:13px; box-shadow:var(--shadow-sm); border:1px solid #E5E7EB;" onclick="app.modal.open('pom-stock')">Isi Tangki</button>
                <button class="btn-large" style="flex:1; background:#E5E7EB; color:var(--text-main); font-size:13px; box-shadow:none;" onclick="app.modal.open('pom-price')">Set Harga</button>
            </div>

            <div class="pom-lcd-screen">Rp <span id="pom-val-display">0</span></div>
            
            <div class="form-group">
                <label class="form-label">Nominal Pembelian (Rp)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="pom-input-rp" class="form-input" placeholder="0" oninput="app.pom.calcByRp(this.value)">
                    <button class="btn-ai-pill" onclick="app.ai.checkFuelPrice()">Cek Pasar</button>
                </div>
            </div>

            <button class="btn-large" style="background:var(--pertalite-color)" onclick="app.pom.pay()">Bayar & Cetak Struk</button>
        </section>

        <section id="view-products" class="view-section">
            <div class="search-container">
                <input type="text" placeholder="Cari produk untuk diedit..." oninput="app.products.render(this.value)">
                <button class="btn-small" onclick="app.products.clickAdd()">+ Baru</button>
            </div>
            <div class="list-container" id="product-list-view"></div>
        </section>

        <section id="view-expenses" class="view-section">
            <div class="section-header">
                <span class="section-title">Daftar Pengeluaran</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-ai-pill" onclick="app.ai.analyzeExpense()">Saran Hemat</button>
                    <button class="btn-small" style="background:var(--expense-color)" onclick="app.modal.open('expense')">+ Catat</button>
                </div>
            </div>
            <div class="list-container" id="expense-list-view"></div>
        </section>

    </div>

    <div class="ai-float-btn" onclick="app.modal.open('chat')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-dashboard" onclick="app.nav.to('dashboard')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
            <span>Home</span>
        </div>
        <div class="nav-item" id="nav-pos" onclick="app.nav.to('pos')">
            <svg class="icon" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
            <span>Kasir</span>
        </div>
        <div class="nav-item nav-item-pom" id="nav-pom" onclick="app.nav.to('pom')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 22v-8a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v8"></path><path d="M18 22v-8a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v8"></path><path d="M13 2L3 12"></path><path d="M21 2L11 12"></path></svg>
            <span>POM</span>
        </div>
        <div class="nav-item" id="nav-products" onclick="app.nav.to('products')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
            <span>Produk</span>
        </div>
        <div class="nav-item" id="nav-expenses" onclick="app.nav.to('expenses')">
            <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            <span>Biaya</span>
        </div>
    </nav>

    <div id="modal-scan" class="modal"><div class="modal-sheet" style="background:#000; color:white; min-height:60vh;"><div style="margin-bottom:15px; font-weight:700; font-size:18px;">Scan Barcode</div><div id="scanner-container"></div><button class="btn-large" style="background:#333; margin-top:20px;" onclick="app.scanner.stop()">Tutup Kamera</button></div></div>

    <div id="modal-settings" class="modal" onclick="if(event.target===this) app.modal.close('settings')">
        <div class="modal-sheet">
            <div style="font-weight:800; font-size:24px; margin-bottom:20px;">Pengaturan Toko</div>
            <div class="form-group"><label class="form-label">Nama Toko</label><input id="set-name" class="form-input"></div>
            <div class="form-group"><label class="form-label">Alamat Toko</label><input id="set-addr" class="form-input"></div>
            <div class="form-group">
                <label class="form-label">Footer Struk</label>
                <div style="display:flex;gap:10px"><input id="set-foot" class="form-input"><button class="btn-ai-pill" onclick="app.ai.genFooter()">AI</button></div>
            </div>
            <div class="form-group"><label class="form-label">PIN Akses (6 Angka)</label><input type="number" id="set-pin" class="form-input"></div>
            <div class="form-group"><label class="form-label">API Key (Groq AI)</label><input type="password" id="set-api" class="form-input"></div>
            <button class="btn-large" onclick="app.settings.save()">Simpan Perubahan</button>
            <button class="btn-large" style="background:#E5E7EB; color:#1F2937; margin-top:12px;" onclick="app.settings.reset()">Reset Semua Data</button>
        </div>
    </div>

    <div id="modal-profile" class="modal" onclick="if(event.target===this) app.modal.close('profile')">
        <div class="modal-sheet" style="text-align:center;">
            <img id="prof-img-prev" style="width:100px; height:100px; border-radius:50%; margin-bottom:20px; object-fit:cover; box-shadow:var(--shadow-float);">
            <br><input type="file" onchange="app.profile.handleImage(this)" style="margin-bottom:20px;">
            <div class="form-group" style="text-align:left;"><label class="form-label">Nama Kasir / Pemilik</label><input id="prof-name" class="form-input"></div>
            <button class="btn-large" onclick="app.profile.save()">Simpan Profil</button>
        </div>
    </div>

    <div id="modal-expense" class="modal" onclick="if(event.target===this) app.modal.close('expense')">
        <div class="modal-sheet">
            <div style="font-weight:800; font-size:24px; margin-bottom:20px;">Catat Pengeluaran</div>
            <div class="form-group"><label class="form-label">Keterangan Biaya</label><input id="exp-desc" class="form-input" placeholder="Contoh: Listrik, Kulak Barang"></div>
            <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="exp-val" class="form-input"></div>
            <button class="btn-large" style="background:var(--expense-color)" onclick="app.expenses.add()">Simpan Biaya</button>
        </div>
    </div>

    <div id="modal-product" class="modal" onclick="if(event.target===this) app.modal.close('product')">
        <div class="modal-sheet">
            <div style="font-weight:800; font-size:24px; margin-bottom:20px;">Editor Produk</div>
            <input type="hidden" id="p-id">
            <div class="form-group">
                <label class="form-label">Nama Produk</label>
                <div style="display:flex;gap:10px"><input id="p-name" class="form-input"><button class="btn-ai-pill" onclick="app.ai.genProductName()">AI</button></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1.5fr; gap:15px;">
                <div class="form-group"><label class="form-label">Stok</label><input type="number" id="p-stock" class="form-input"></div>
                <div class="form-group">
                    <label class="form-label">Barcode</label>
                    <div style="display:flex;gap:10px"><input id="p-code" class="form-input"><button class="btn-small" style="background:#1F2937;" onclick="app.scanner.start('fill')">Scan</button></div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="form-group"><label class="form-label">Harga Modal</label><input type="number" id="p-buy" class="form-input"></div>
                <div class="form-group"><label class="form-label">Harga Jual</label><input type="number" id="p-sell" class="form-input"></div>
            </div>
            <button class="btn-large" onclick="app.products.save()">Simpan Produk</button>
            <button class="btn-large" id="btn-del-prod" style="background:var(--danger-color); margin-top:15px; display:none;" onclick="app.products.del()">Hapus Produk</button>
        </div>
    </div>

    <div id="modal-pay" class="modal" onclick="if(event.target===this) app.modal.close('pay')">
        <div class="modal-sheet">
            <div style="font-weight:800; font-size:24px; margin-bottom:20px;">Pembayaran</div>
            <div style="font-size:40px; font-weight:800; text-align:center; margin-bottom:24px; color:var(--primary-dark);" id="pay-total-display">0</div>
            
            <div class="form-group"><label class="form-label">Uang Tunai Diterima</label><input type="number" id="pay-cash" class="form-input" style="font-size:24px; font-weight:700;" oninput="app.pos.calcChange(this.value)"></div>
            <div style="font-weight:700; font-size:18px; margin-bottom:30px; text-align:right;">Kembali: <span id="pay-change" style="color:var(--success-color)">0</span></div>
            <button class="btn-large" onclick="app.pos.finish()">Bayar & Cetak Struk</button>
        </div>
    </div>

    <div id="modal-pom-stock" class="modal"><div class="modal-sheet"><div style="font-weight:800;font-size:20px;margin-bottom:15px">Tambah Stok Pertalite</div><input type="number" id="pom-add-l" class="form-input" placeholder="Jumlah Liter"><br><button class="btn-large" onclick="app.pom.addStock()">Simpan</button><button class="btn-large" style="background:#E5E7EB; color:#333; margin-top:10px" onclick="app.modal.close('pom-stock')">Batal</button></div></div>
    <div id="modal-pom-price" class="modal"><div class="modal-sheet"><div style="font-weight:800;font-size:20px;margin-bottom:15px">Set Harga Pertalite</div><input type="number" id="pom-set-p" class="form-input" placeholder="Harga per Liter"><br><button class="btn-large" onclick="app.pom.setPrice()">Simpan</button><button class="btn-large" style="background:#E5E7EB; color:#333; margin-top:10px" onclick="app.modal.close('pom-price')">Batal</button></div></div>

    <div id="modal-chat" class="modal"><div class="modal-sheet" style="height:75vh; display:flex; flex-direction:column;"><div style="font-weight:800; font-size:18px; padding-bottom:15px; border-bottom:1px solid #eee;">AI Asisten</div><div id="chat-history" class="ai-chat-box"><div class="ai-msg bot">Halo! Saya siap membantu bisnis Anda. Ada yang bisa saya bantu?</div></div><div style="display:flex; gap:10px; margin-top:auto;"><input id="chat-input" class="form-input" placeholder="Ketik pertanyaan..."><button class="btn-ai-pill" style="height:auto; width:60px; justify-content:center;" onclick="app.ai.send()">Kirim</button></div><button class="btn-large" style="background:#E5E7EB; color:#333; margin-top:12px;" onclick="app.modal.close('chat')">Tutup</button></div></div>

    <div id="receipt-area" style="display:none;"></div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            play: (type) => {
                if (AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
                const osc = AudioEngine.ctx.createOscillator();
                const gain = AudioEngine.ctx.createGain();
                osc.connect(gain); gain.connect(AudioEngine.ctx.destination);
                
                if (type === 'click') {
                    osc.frequency.setValueAtTime(600, AudioEngine.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.00001, AudioEngine.ctx.currentTime + 0.1);
                    osc.start(); osc.stop(AudioEngine.ctx.currentTime + 0.1);
                } else if (type === 'success') {
                    osc.frequency.setValueAtTime(800, AudioEngine.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(1200, AudioEngine.ctx.currentTime + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.00001, AudioEngine.ctx.currentTime + 0.3);
                    osc.start(); osc.stop(AudioEngine.ctx.currentTime + 0.3);
                } else if (type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, AudioEngine.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.00001, AudioEngine.ctx.currentTime + 0.3);
                    osc.start(); osc.stop(AudioEngine.ctx.currentTime + 0.3);
                }
            }
        };

        // --- UTILITIES ---
        const formatRupiah = (n) => 'Rp ' + parseInt(n).toLocaleString('id-ID');
        const generateID = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        // --- MAIN APP LOGIC ---
        const app = {
            data: {
                profile: { name: 'Toko Saya', owner: 'Admin', address: 'Indonesia', footer: 'Terima Kasih', pin: '123456', apiKey: '', img: '' },
                products: [],
                transactions: [],
                expenses: [],
                cart: [],
                pom: { price: 10000, stock: 100, capacity: 200 }
            },
            chartInstance: null,
            pinBuffer: '',

            init: () => {
                const stored = localStorage.getItem('kasirq_v19_ultra');
                if (stored) {
                    try {
                        app.data = JSON.parse(stored);
                        if (!app.data.expenses) app.data.expenses = [];
                        if (!app.data.pom) app.data.pom = { price: 10000, stock: 100, capacity: 200 };
                    } catch (e) { console.error("Data Corrupt"); }
                } else {
                    app.data.products = [{ id: generateID(), name: 'Kopi Hitam', stock: 50, buy: 3000, sell: 5000, code: '123' }];
                    app.save();
                }

                // Load Images
                const defaultImg = 'https://via.placeholder.com/100?text=USER';
                document.getElementById('header-avatar').src = app.data.profile.img || defaultImg;
                document.getElementById('prof-img-prev').src = app.data.profile.img || defaultImg;

                // Splash
                setTimeout(() => {
                    document.getElementById('splash-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('splash-screen').remove();
                        document.getElementById('pin-screen').style.display = 'flex';
                    }, 600);
                }, 1800);
            },

            save: () => localStorage.setItem('kasirq_v19_ultra', JSON.stringify(app.data)),

            notify: (msg) => {
                document.getElementById('notif-msg').innerText = msg;
                const n = document.getElementById('notification');
                n.style.transform = 'translateY(0)';
                setTimeout(() => { n.style.transform = 'translateY(-150px)'; }, 2500);
            },

            // --- PIN LOGIC ---
            pin: {
                render: () => {
                    document.querySelectorAll('.pin-dot').forEach((d, i) => {
                        if (i < app.pinBuffer.length) d.classList.add('filled');
                        else d.classList.remove('filled');
                    });
                },
                enter: (num) => {
                    AudioEngine.play('click');
                    if (app.pinBuffer.length < 6) {
                        app.pinBuffer += num;
                        app.pin.render();
                        if (app.pinBuffer.length === 6) setTimeout(app.pin.validate, 200);
                    }
                },
                del: () => {
                    AudioEngine.play('click');
                    app.pinBuffer = app.pinBuffer.slice(0, -1);
                    app.pin.render();
                },
                validate: () => {
                    if (app.pinBuffer === app.data.profile.pin) {
                        AudioEngine.play('success');
                        document.getElementById('pin-screen').style.display = 'none';
                        app.nav.to('dashboard');
                    } else {
                        AudioEngine.play('error');
                        const pad = document.querySelector('.pin-pad');
                        pad.classList.add('shake');
                        setTimeout(() => { 
                            pad.classList.remove('shake'); 
                            app.pinBuffer = ''; 
                            app.pin.render(); 
                        }, 400);
                    }
                }
            },

            // --- NAVIGATION ---
            nav: {
                to: (viewId) => {
                    // Hide All Sections
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    // Show Target
                    document.getElementById('view-' + viewId).classList.add('active');
                    
                    // Update Bottom Nav
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.nav-item-pom').forEach(el => el.classList.remove('active'));
                    if (document.getElementById('nav-' + viewId)) document.getElementById('nav-' + viewId).classList.add('active');
                    if (viewId === 'pom') document.getElementById('nav-pom').classList.add('active');

                    // Title Update
                    const titles = { dashboard:'Dashboard', pos:'Kasir', pom:'POM Mini', products:'Produk', expenses:'Pengeluaran' };
                    document.getElementById('page-title').innerText = titles[viewId] || 'Aplikasi';

                    // Execute Render Logic
                    if(viewId === 'dashboard') app.dashboard.render();
                    if(viewId === 'pos') app.pos.render();
                    if(viewId === 'pom') app.pom.render();
                    if(viewId === 'products') app.products.render();
                    if(viewId === 'expenses') app.expenses.render();
                }
            },

            modal: {
                open: (id) => {
                    if (id === 'settings') app.settings.render();
                    if (id === 'profile') app.profile.render();
                    document.getElementById('modal-' + id).classList.add('show');
                },
                close: (id) => document.getElementById('modal-' + id).classList.remove('show')
            },

            // --- DASHBOARD LOGIC ---
            dashboard: {
                render: () => {
                    const now = new Date().toISOString().slice(0, 7);
                    const income = app.data.transactions.filter(t => t.date.startsWith(now)).reduce((sum, t) => sum + t.total, 0);
                    const expense = app.data.expenses.filter(e => e.date.startsWith(now)).reduce((sum, e) => sum + e.val, 0);
                    
                    // Split Stats
                    const retail = app.data.transactions.filter(t => t.date.startsWith(now) && t.type === 'retail').reduce((s, t) => s + t.total, 0);
                    const pom = app.data.transactions.filter(t => t.date.startsWith(now) && t.type === 'pom').reduce((s, t) => s + t.total, 0);

                    document.getElementById('dash-omzet').innerText = income.toLocaleString('id-ID');
                    document.getElementById('dash-retail').innerText = formatRupiah(retail);
                    document.getElementById('dash-pom').innerText = formatRupiah(pom);
                    document.getElementById('report-income').innerText = formatRupiah(income);
                    document.getElementById('report-expense').innerText = formatRupiah(expense);

                    // Chart
                    const ctx = document.getElementById('monthlyChart').getContext('2d');
                    if (app.chartInstance) app.chartInstance.destroy();
                    app.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Masuk', 'Keluar'],
                            datasets: [{
                                data: [income, expense > 0 ? expense : 1],
                                backgroundColor: ['#10B981', '#EF4444'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
                    });

                    // History
                    const list = document.getElementById('dashboard-history-list');
                    list.innerHTML = '';
                    const mixed = [
                        ...app.data.transactions.map(t => ({...t, kind:'in'})),
                        ...app.data.expenses.map(e => ({...e, kind:'out'}))
                    ].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);

                    mixed.forEach(item => {
                        const isOut = item.kind === 'out';
                        const icon = isOut ? 'ðŸ’¸' : (item.type === 'pom' ? 'â›½' : 'ðŸ›’');
                        const title = isOut ? item.desc : (item.type === 'pom' ? 'Bensin' : 'Penjualan');
                        const val = isOut ? item.val : item.total;
                        
                        list.innerHTML += `
                        <div class="list-item">
                            <div class="li-left">
                                <div class="li-icon ${isOut?'red':''}">${icon}</div>
                                <div class="li-info"><h4>${title}</h4><p>${new Date(item.date).toLocaleString()}</p></div>
                            </div>
                            <div class="li-amount ${isOut?'negative':''}">${isOut?'-':'+'} ${formatRupiah(val)}</div>
                        </div>`;
                    });
                }
            },

            // --- POS LOGIC ---
            pos: {
                tempTotal: 0,
                render: () => {
                    app.pos.filterProducts('');
                    app.pos.renderCart();
                },
                renderCart: () => {
                    const el = document.getElementById('pos-cart-list');
                    const totEl = document.getElementById('pos-total-display');
                    el.innerHTML = '';
                    app.pos.tempTotal = 0;

                    if (app.data.cart.length === 0) {
                        el.innerHTML = '<div style="text-align:center; padding:30px; color:#9CA3AF; font-style:italic;">Keranjang Belanja Kosong</div>';
                        totEl.innerText = '0';
                        return;
                    }

                    app.data.cart.forEach(item => {
                        app.pos.tempTotal += item.sell * item.qty;
                        el.innerHTML += `
                        <div class="cart-item">
                            <div><span style="font-weight:700; font-size:14px;">${item.name}</span><br><small style="color:#6B7280">${formatRupiah(item.sell)}</small></div>
                            <div class="cart-controls">
                                <button class="qty-btn" onclick="app.pos.modQty('${item.id}', -1)">-</button>
                                <span style="font-weight:600; min-width:20px; text-align:center;">${item.qty}</span>
                                <button class="qty-btn" onclick="app.pos.modQty('${item.id}', 1)">+</button>
                            </div>
                        </div>`;
                    });
                    totEl.innerText = formatRupiah(app.pos.tempTotal);
                },
                addToCart: (id, qty) => {
                    const p = app.data.products.find(x => x.id === id);
                    if(p.stock <= 0) return alert('Stok Habis!');
                    const exist = app.data.cart.find(x => x.id === id);
                    if(exist) exist.qty += qty;
                    else app.data.cart.push({ ...p, qty: qty });
                    
                    app.pos.renderCart();
                    app.notify('Produk Masuk Keranjang');
                    AudioEngine.play('click');
                },
                modQty: (id, delta) => {
                    const item = app.data.cart.find(x => x.id === id);
                    item.qty += delta;
                    if(item.qty <= 0) app.data.cart = app.data.cart.filter(x => x.id !== id);
                    app.pos.renderCart();
                },
                clearCart: () => { 
                    if(confirm('Hapus Semua Item Keranjang?')) { 
                        app.data.cart = []; 
                        app.pos.renderCart(); 
                    } 
                },
                filterProducts: (key) => {
                    const grid = document.getElementById('pos-product-grid');
                    grid.innerHTML = '';
                    app.data.products.filter(p => p.name.toLowerCase().includes(key.toLowerCase()) || p.code == key).forEach(p => {
                        grid.innerHTML += `
                        <div class="product-card" onclick="app.pos.addToCart('${p.id}', 1)">
                            <div class="p-badge">Stok: ${p.stock}</div>
                            <div class="p-icon">ðŸ“¦</div>
                            <div class="p-name">${p.name}</div>
                            <div class="p-price">${formatRupiah(p.sell)}</div>
                        </div>`;
                    });
                },
                checkout: () => {
                    if(app.data.cart.length === 0) return alert('Keranjang kosong!');
                    document.getElementById('pay-total-display').innerText = formatRupiah(app.pos.tempTotal);
                    app.modal.open('pay');
                    app.ai.getProductSuggestion(app.data.cart);
                },
                calcChange: (val) => {
                    const cash = parseInt(val) || 0;
                    document.getElementById('pay-change').innerText = formatRupiah(Math.max(0, cash - app.pos.tempTotal));
                },
                finish: () => {
                    const cash = parseInt(document.getElementById('pay-cash').value) || 0;
                    if (cash < app.pos.tempTotal) return alert('Uang Kurang!');
                    
                    const trx = {
                        id: generateID(),
                        date: new Date().toISOString(),
                        type: 'retail',
                        items: [...app.data.cart],
                        total: app.pos.tempTotal,
                        cash: cash,
                        change: cash - app.pos.tempTotal
                    };
                    
                    app.data.cart.forEach(c => {
                        const p = app.data.products.find(x => x.id === c.id);
                        if(p) p.stock -= c.qty;
                    });

                    app.data.transactions.push(trx);
                    app.save();
                    app.printer.print(trx);
                    app.data.cart = [];
                    app.pos.render();
                    app.modal.close('pay');
                    app.notify('Transaksi Berhasil!');
                    AudioEngine.play('success');
                }
            },

            // --- POM LOGIC ---
            pom: {
                tempTrx: null,
                render: () => {
                    const s = app.data.pom;
                    const pct = (s.stock / s.capacity) * 100;
                    document.getElementById('tank-fill').style.width = pct + '%';
                    document.getElementById('tank-info').innerText = `Stok: ${s.stock.toFixed(1)}L / ${s.capacity}L`;
                    document.getElementById('pom-price-display').innerText = `${formatRupiah(s.price)} / Liter`;
                },
                calcByRp: (val) => {
                    const rp = parseInt(val) || 0;
                    const lit = rp / app.data.pom.price;
                    document.getElementById('pom-val-display').innerText = rp.toLocaleString();
                    app.pom.tempTrx = { rp, lit };
                },
                pay: () => {
                    if (!app.pom.tempTrx || app.pom.tempTrx.rp <= 0) return alert('Isi nominal dulu');
                    if (app.pom.tempTrx.lit > app.data.pom.stock) return alert('Stok Bensin Habis!');
                    
                    const trx = {
                        id: generateID(),
                        date: new Date().toISOString(),
                        type: 'pom',
                        total: app.pom.tempTrx.rp,
                        lit: app.pom.tempTrx.lit,
                        cash: app.pom.tempTrx.rp
                    };
                    app.data.transactions.push(trx);
                    app.data.pom.stock -= trx.lit;
                    app.save();
                    app.printer.print(trx);
                    app.pom.render();
                    document.getElementById('pom-input-rp').value = '';
                    app.notify('Transaksi POM Berhasil');
                    AudioEngine.play('success');
                },
                addStock: () => {
                    const add = parseFloat(document.getElementById('pom-add-l').value);
                    if(add) { app.data.pom.stock += add; app.save(); app.pom.render(); app.modal.close('pom-stock'); app.notify('Stok Ditambah'); }
                },
                setPrice: () => {
                    const p = parseInt(document.getElementById('pom-set-p').value);
                    if(p) { app.data.pom.price = p; app.save(); app.pom.render(); app.modal.close('pom-price'); app.notify('Harga Disimpan'); }
                }
            },

            // --- PRODUCTS LOGIC (FIXED CRUD) ---
            products: {
                render: (key = '') => {
                    const list = document.getElementById('product-list-view');
                    list.innerHTML = '';
                    app.data.products.filter(p => p.name.toLowerCase().includes(key.toLowerCase())).forEach(p => {
                        list.innerHTML += `
                        <div class="list-item" onclick="app.products.clickEdit('${p.id}')">
                            <div class="li-left">
                                <div class="li-icon">ðŸ“¦</div>
                                <div class="li-info"><h4>${p.name}</h4><p>Stok: ${p.stock}</p></div>
                            </div>
                            <div class="li-amount">${formatRupiah(p.sell)}</div>
                        </div>`;
                    });
                },
                clickAdd: () => {
                    document.getElementById('p-id').value = ''; // Reset ID
                    document.getElementById('p-name').value = '';
                    document.getElementById('p-stock').value = '';
                    document.getElementById('p-code').value = '';
                    document.getElementById('p-buy').value = '';
                    document.getElementById('p-sell').value = '';
                    // Sembunyikan tombol hapus
                    document.getElementById('btn-del-prod').style.display = 'none';
                    app.modal.open('product');
                },
                clickEdit: (id) => {
                    const p = app.data.products.find(x => x.id === id);
                    document.getElementById('p-id').value = p.id; // Set ID
                    document.getElementById('p-name').value = p.name;
                    document.getElementById('p-stock').value = p.stock;
                    document.getElementById('p-code').value = p.code;
                    document.getElementById('p-buy').value = p.buy;
                    document.getElementById('p-sell').value = p.sell;
                    // Tampilkan tombol hapus
                    document.getElementById('btn-del-prod').style.display = 'block';
                    app.modal.open('product');
                },
                save: () => {
                    const id = document.getElementById('p-id').value;
                    const newProd = {
                        id: id || generateID(),
                        name: document.getElementById('p-name').value,
                        stock: parseInt(document.getElementById('p-stock').value),
                        code: document.getElementById('p-code').value,
                        buy: parseInt(document.getElementById('p-buy').value),
                        sell: parseInt(document.getElementById('p-sell').value)
                    };
                    
                    if (id) {
                        // EDIT MODE
                        const idx = app.data.products.findIndex(x => x.id === id);
                        app.data.products[idx] = newProd;
                    } else {
                        // ADD MODE
                        app.data.products.push(newProd);
                    }
                    app.save();
                    app.products.render();
                    app.modal.close('product');
                    app.notify('Produk Disimpan');
                    AudioEngine.play('success');
                },
                del: () => {
                    if (confirm('Yakin ingin menghapus produk ini?')) {
                        const id = document.getElementById('p-id').value;
                        app.data.products = app.data.products.filter(x => x.id !== id);
                        app.save();
                        app.products.render();
                        app.modal.close('product');
                        app.notify('Produk Dihapus');
                    }
                }
            },

            // --- EXPENSES LOGIC ---
            expenses: {
                render: () => {
                    const list = document.getElementById('expense-list-view');
                    list.innerHTML = '';
                    app.data.expenses.slice().reverse().forEach(e => {
                        list.innerHTML += `
                        <div class="list-item">
                            <div class="li-left">
                                <div class="li-icon red">ðŸ’¸</div>
                                <div class="li-info"><h4>${e.desc}</h4><p>${new Date(e.date).toLocaleDateString()}</p></div>
                            </div>
                            <div class="li-amount negative">- ${formatRupiah(e.val)}</div>
                        </div>`;
                    });
                },
                add: () => {
                    const desc = document.getElementById('exp-desc').value;
                    const val = parseInt(document.getElementById('exp-val').value);
                    if (desc && val) {
                        app.data.expenses.push({ id: generateID(), date: new Date().toISOString(), desc: desc, val: val });
                        app.save();
                        app.expenses.render();
                        app.modal.close('expense');
                        app.notify('Pengeluaran Dicatat');
                        AudioEngine.play('success');
                    }
                }
            },

            // --- SCANNER ---
            scanner: {
                instance: null, mode: '',
                start: (m) => {
                    app.scanner.mode = m;
                    app.modal.open('scan');
                    if (!app.scanner.instance) {
                        app.scanner.instance = new Html5QrcodeScanner("scanner-container", { fps: 10, qrbox: 250 });
                        app.scanner.instance.render(app.scanner.onScan);
                    }
                },
                stop: () => app.modal.close('scan'),
                onScan: (res) => {
                    if (app.scanner.mode === 'fill') {
                        document.getElementById('p-code').value = res;
                        app.scanner.stop();
                        app.notify('Barcode Terisi');
                    } else {
                        const p = app.data.products.find(x => x.code == res);
                        if (p) { app.pos.addToCart(p.id, 1); app.scanner.stop(); }
                        else alert('Produk tidak ditemukan');
                    }
                    AudioEngine.play('success');
                }
            },

            // --- AI (GROQ) ---
            ai: {
                call: async (msg, sys) => {
                    if (!app.data.profile.apiKey) return "Error: Masukkan API Key di Pengaturan.";
                    try {
                        const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${app.data.profile.apiKey}`, "Content-Type": "application/json" },
                            body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role:"system",content:sys},{role:"user",content:msg}] })
                        });
                        const d = await r.json(); return d.choices[0].message.content;
                    } catch(e) { return "Gagal koneksi AI. Cek internet/API Key."; }
                },
                openChat: () => app.modal.open('chat'),
                send: async () => {
                    const inp = document.getElementById('chat-input');
                    const txt = inp.value; if(!txt)return;
                    const box = document.getElementById('chat-history');
                    box.innerHTML += `<div class="ai-msg user">${txt}</div>`;
                    inp.value = '';
                    const res = await app.ai.call(txt, "Kamu adalah asisten bisnis pintar.");
                    box.innerHTML += `<div class="ai-msg bot">${marked.parse(res)}</div>`;
                    box.scrollTop = box.scrollHeight;
                },
                
                analyzeDashboard: async () => {
                    const t = document.getElementById('ai-insight-text'); t.style.display='block'; t.innerText = "Menganalisa...";
                    const res = await app.ai.call(`Omzet bulan ini ${document.getElementById('dash-omzet').innerText}. Berikan analisis singkat.`, "Bisnis Analis");
                    t.innerText = res;
                },
                getProductSuggestion: async (cart) => {
                    if(cart.length === 0) return;
                    const box = document.getElementById('ai-checkout-suggest'); box.style.display='block'; box.innerText = "Mencari saran...";
                    const items = cart.map(i => i.name).join(', ');
                    const res = await app.ai.call(`Pelanggan beli: ${items}. Sarankan 1 produk lain untuk ditawarkan.`, "Sales Expert");
                    box.innerText = "ðŸ’¡ Saran: " + res;
                },
                checkFuelPrice: async () => { alert("Harga Pasar: " + await app.ai.call("Berapa harga eceran pertalite hari ini di warung?", "Market Research")); },
                genProductName: async () => {
                    const v = document.getElementById('p-name').value;
                    const res = await app.ai.call(`Buat nama produk menarik untuk: ${v}`, "Marketing");
                    document.getElementById('p-name').value = res.replace(/"/g, '');
                },
                genFooter: async () => {
                    const res = await app.ai.call(`Buat footer struk pendek lucu untuk: ${app.data.profile.name}`, "Copywriter");
                    document.getElementById('set-foot').value = res.replace(/"/g, '');
                },
                analyzeExpense: async () => { alert(await app.ai.call("Saya punya pengeluaran operasional toko. Berikan tips hemat singkat.", "Financial Advisor")); }
            },

            // --- PRINTER ---
            printer: {
                print: (t) => {
                    let rows = t.type === 'retail' ? t.items.map(i => `<tr><td>${i.name}<br>${i.qty} x ${i.sell}</td><td align="right">${formatRupiah(i.sell * i.qty)}</td></tr>`).join('') : `<tr><td>Bensin<br>${t.lit.toFixed(2)}L</td><td align="right">${formatRupiah(t.total)}</td></tr>`;
                    document.getElementById('receipt-area').innerHTML = `
                        <div style="font-family:'Courier New'; font-size:12px; width:58mm; text-align:center; padding:10px 0;">
                            <h3>${app.data.profile.name}</h3>
                            <p>${app.data.profile.address}</p>
                            <hr style="border-top:1px dashed #000;">
                            <table width="100%">${rows}</table>
                            <hr style="border-top:1px dashed #000;">
                            <table width="100%">
                                <tr><td>Total</td><td align="right">${formatRupiah(t.total)}</td></tr>
                                <tr><td>Bayar</td><td align="right">${formatRupiah(t.cash)}</td></tr>
                                <tr><td>Kembali</td><td align="right">${formatRupiah(t.change)}</td></tr>
                            </table>
                            <br><small>${app.data.profile.footer}</small>
                            <br><small>${new Date(t.date).toLocaleString()}</small>
                        </div>`;
                    window.print();
                }
            },

            // --- SETTINGS & PROFILE ---
            profile: {
                render: () => { document.getElementById('prof-name').value = app.data.profile.owner; },
                handleImage: (input) => {
                    if (input.files[0]) {
                        const r = new FileReader();
                        r.onload = (e) => {
                            app.data.profile.img = e.target.result;
                            document.getElementById('prof-img-prev').src = e.target.result;
                            document.getElementById('header-avatar').src = e.target.result;
                        };
                        r.readAsDataURL(input.files[0]);
                    }
                },
                save: () => {
                    app.data.profile.owner = document.getElementById('prof-name').value;
                    app.save(); app.modal.close('profile'); app.notify('Profil Disimpan');
                }
            },
            settings: {
                render: () => {
                    const p = app.data.profile;
                    document.getElementById('set-name').value = p.name;
                    document.getElementById('set-addr').value = p.address;
                    document.getElementById('set-foot').value = p.footer;
                    document.getElementById('set-pin').value = p.pin;
                    document.getElementById('set-api').value = p.apiKey;
                },
                save: () => {
                    const p = app.data.profile;
                    p.name = document.getElementById('set-name').value;
                    p.address = document.getElementById('set-addr').value;
                    p.footer = document.getElementById('set-foot').value;
                    p.pin = document.getElementById('set-pin').value;
                    p.apiKey = document.getElementById('set-api').value;
                    app.save(); location.reload();
                },
                reset: () => {
                    if(confirm("Hapus semua data aplikasi?")) { localStorage.clear(); location.reload(); }
                }
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>